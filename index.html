<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Planner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .drag-over { outline: 2px dashed #f59e0b; outline-offset: -2px; }
    .dragging { opacity: 0.5; }

    @media print {
      body { background: white; color: black; }
      .no-print { display: none !important; }
      .week-grid { page-break-inside: avoid; }
      .meal-card { border: 1px solid #ccc; background: white; color: black; }
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-4">
  <div id="app" class="max-w-2xl mx-auto"></div>

  <script>
    const STORAGE_KEY = 'meal-planner-v2';

    const defaultMeals = [
      { id: 1, name: 'Shrimp Pasta', type: 'cook', category: 'Main', ingredients: ['Noodles', 'Frozen Garlic Shrimp'], instructions: [] },
      { id: 2, name: 'Pizza', type: 'order', category: 'Main', place: 'Pinks' },
      { id: 3, name: 'Ramen', type: 'order', category: 'Main', place: 'Jinya' },
      { id: 4, name: 'Barnabys', type: 'order', category: 'Main', place: 'Barnabys' },
      { id: 5, name: 'El Tiempo', type: 'order', category: 'Main', place: 'El Tiempo' },
      { id: 6, name: 'Mac & Cheese', type: 'cook', category: 'Main', ingredients: ["Amy's Box", 'Milk', 'Butter'], instructions: [] },
      { id: 7, name: 'Chicken Nuggets', type: 'cook', category: 'Main', ingredients: ['Frozen Chicken Nuggets'], instructions: [] },
      { id: 8, name: 'BBQ Chicken', type: 'cook', category: 'Main', ingredients: ['Marinated Chicken Thighs'], instructions: [] },
    ];

    const CATEGORIES = ['All', 'Main', 'Soup', 'Bread', 'Dessert', 'Side', 'Salad', 'Condiment', 'Drink'];
    const CATEGORY_COLORS = {
      Main: 'bg-green-900 text-green-300',
      Soup: 'bg-orange-900 text-orange-300',
      Bread: 'bg-yellow-900 text-yellow-300',
      Dessert: 'bg-pink-900 text-pink-300',
      Side: 'bg-purple-900 text-purple-300',
      Salad: 'bg-emerald-900 text-emerald-300',
      Condiment: 'bg-red-900 text-red-300',
      Drink: 'bg-cyan-900 text-cyan-300',
    };

    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    let state = load();
    let activeFilter = 'All';
    let recipesLoaded = false;

    function load() {
      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (saved && saved.meals && saved.week) return saved;
      } catch (e) {}
      return { meals: [...defaultMeals], week: {} };
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    async function loadRecipes() {
      try {
        const resp = await fetch('recipes.json');
        if (!resp.ok) return;
        const recipes = await resp.json();
        const existingIds = new Set(state.meals.map(m => m.id));
        let added = 0;
        for (const r of recipes) {
          if (!existingIds.has(r.id)) {
            state.meals.push(r);
            existingIds.add(r.id);
            added++;
          }
        }
        if (added > 0) {
          save();
          console.log(`Loaded ${added} new recipes`);
        }
        recipesLoaded = true;
      } catch (e) {
        console.log('No recipes.json found, using defaults');
      }
      render();
    }

    function catColor(cat) {
      return CATEGORY_COLORS[cat] || 'bg-slate-700 text-slate-300';
    }

    function filteredMeals() {
      if (activeFilter === 'All') return state.meals;
      return state.meals.filter(m => m.category === activeFilter);
    }

    function render() {
      const meals = filteredMeals();
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold">Meal Planner</h1>
          <div class="flex gap-3">
            <button onclick="printWeek()" class="text-sm px-3 py-1.5 bg-amber-600 hover:bg-amber-700 rounded no-print">üñ®Ô∏è Print</button>
            <button onclick="exportToNotion()" class="text-sm px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded no-print">üìã Copy for Notion</button>
            <button onclick="clearWeek()" class="text-sm text-slate-500 hover:text-slate-300 no-print">Clear Week</button>
          </div>
        </div>

        <!-- Week Grid -->
        <div class="week-grid grid grid-cols-1 gap-3 mb-8">
          ${days.map(day => {
            const mealId = state.week[day];
            const meal = mealId ? state.meals.find(m => m.id === mealId) : null;
            return `
              <div class="rounded-lg p-4 ${meal ? 'bg-slate-700 border-2 border-amber-500/50' : 'bg-slate-800 border-2 border-dashed border-slate-600'}"
                   ondragover="event.preventDefault(); this.classList.add('drag-over')"
                   ondragleave="this.classList.remove('drag-over')"
                   ondrop="dropMeal(event, '${day}'); this.classList.remove('drag-over')">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-slate-400 w-24">${day}</span>
                    ${meal ? `
                      <div class="flex-1 flex items-center gap-2">
                        <span class="font-semibold text-amber-300">${meal.name}</span>
                        <span class="text-xs px-2 py-0.5 rounded ${meal.type === 'order' ? 'bg-blue-900 text-blue-300' : catColor(meal.category)}">${meal.type === 'order' ? meal.place : meal.category || 'cook'}</span>
                      </div>
                      <button onclick="clearDay('${day}')" class="text-slate-500 hover:text-red-400 ml-2 text-lg">&times;</button>
                    ` : `
                      <span class="flex-1 text-slate-600 text-sm">Drag a meal here</span>
                    `}
                  </div>
              </div>
            `;
          }).join('')}
        </div>

        <!-- Category Filters -->
        <div class="flex flex-wrap gap-2 mb-4">
          ${CATEGORIES.filter(c => c === 'All' || state.meals.some(m => m.category === c)).map(cat => `
            <button onclick="setFilter('${cat}')"
                    class="text-xs px-3 py-1.5 rounded-full transition ${activeFilter === cat ? 'bg-amber-500 text-slate-900 font-semibold' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}">
              ${cat}${cat !== 'All' ? ` (${state.meals.filter(m => m.category === cat).length})` : ''}
            </button>
          `).join('')}
        </div>

        <!-- Meals -->
        <h2 class="text-lg font-semibold mb-3 text-slate-300">Meals <span class="text-sm font-normal text-slate-500">(${meals.length})</span></h2>
        <div class="grid grid-cols-2 gap-3 mb-6">
          ${meals.map(meal => `
            <div class="bg-slate-800 rounded-lg p-3 cursor-grab active:cursor-grabbing select-none"
                 draggable="true"
                 ondragstart="dragMeal(event, ${meal.id})"
                 ondragend="this.classList.remove('dragging')">
              <div class="flex justify-between items-start">
                <div class="min-w-0 flex-1">
                  <p class="font-semibold text-amber-300 text-sm truncate">${meal.name}</p>
                  <p class="text-xs text-slate-500 mt-1 truncate">${meal.type === 'order' ? 'Order: ' + meal.place : (meal.ingredients || []).slice(0, 3).join(', ')}</p>
                </div>
                <span class="text-xs px-2 py-0.5 rounded whitespace-nowrap ml-2 ${meal.type === 'order' ? 'bg-blue-900 text-blue-300' : catColor(meal.category)}">${meal.type === 'order' ? 'order' : meal.category || 'cook'}</span>
              </div>
            </div>
          `).join('')}
        </div>

        <!-- Add Meal -->
        <div class="bg-slate-800 rounded-lg p-4">
          <h3 class="text-sm font-semibold text-slate-400 mb-3">Add Meal</h3>
          <div class="flex gap-2 mb-2">
            <input id="new-name" type="text" placeholder="Meal name" class="flex-1 bg-slate-700 rounded px-3 py-2 text-sm">
            <select id="new-type" class="bg-slate-700 rounded px-3 py-2 text-sm" onchange="toggleAddFields()">
              <option value="cook">Cook</option>
              <option value="order">Order</option>
            </select>
          </div>
          <div id="cook-fields">
            <select id="new-category" class="w-full bg-slate-700 rounded px-3 py-2 text-sm mb-2">
              ${CATEGORIES.filter(c => c !== 'All').map(c => `<option value="${c}" ${c === 'Main' ? 'selected' : ''}>${c}</option>`).join('')}
            </select>
            <input id="new-ingredients" type="text" placeholder="Ingredients (comma separated)" class="w-full bg-slate-700 rounded px-3 py-2 text-sm mb-2">
          </div>
          <div id="order-fields" class="hidden">
            <input id="new-place" type="text" placeholder="Restaurant name" class="w-full bg-slate-700 rounded px-3 py-2 text-sm mb-2">
          </div>
          <button onclick="addMeal()" class="bg-amber-500 hover:bg-amber-600 text-slate-900 px-4 py-2 rounded text-sm font-semibold w-full">Add</button>
        </div>
      `;
    }

    function setFilter(cat) {
      activeFilter = cat;
      render();
    }

    function dragMeal(e, id) {
      e.dataTransfer.setData('text/plain', id);
      e.target.classList.add('dragging');
    }

    function dropMeal(e, day) {
      e.preventDefault();
      const id = parseInt(e.dataTransfer.getData('text/plain'));
      state.week[day] = id;
      save();
      render();
    }

    function clearDay(day) {
      delete state.week[day];
      save();
      render();
    }

    function clearWeek() {
      state.week = {};
      save();
      render();
    }

    function printWeek() {
      window.print();
    }

    function exportToNotion() {
      const rows = days.map(day => {
        const mealId = state.week[day];
        const meal = mealId ? state.meals.find(m => m.id === mealId) : null;
        const mealName = meal ? meal.name : '‚Äî';
        const mealType = meal ? (meal.type === 'order' ? `Order (${meal.place})` : meal.category || 'Cook') : '‚Äî';
        return `${day}\t${mealName}\t${mealType}`;
      }).join('\n');

      const text = `Day\tMeal\tType\n${rows}`;

      navigator.clipboard.writeText(text).then(() => {
        alert('‚úÖ Copied to clipboard!\n\nPaste into Notion:\n1. Create a table with columns: Day, Meal, Type\n2. Paste (Ctrl+V) - Notion will auto-format it');
      }).catch(err => {
        alert('‚ùå Copy failed. Please allow clipboard access.');
      });
    }

    function toggleAddFields() {
      const type = document.getElementById('new-type').value;
      document.getElementById('cook-fields').classList.toggle('hidden', type === 'order');
      document.getElementById('order-fields').classList.toggle('hidden', type === 'cook');
    }

    function addMeal() {
      const name = document.getElementById('new-name').value.trim();
      if (!name) return;

      const type = document.getElementById('new-type').value;
      const meal = { id: Date.now(), name, type };

      if (type === 'cook') {
        meal.category = document.getElementById('new-category').value;
        const raw = document.getElementById('new-ingredients').value;
        meal.ingredients = raw.split(',').map(s => s.trim()).filter(Boolean);
        if (!meal.ingredients.length) meal.ingredients = ['(none listed)'];
        meal.instructions = [];
      } else {
        meal.category = 'Main';
        meal.place = document.getElementById('new-place').value.trim() || name;
      }

      state.meals.push(meal);
      save();
      render();
    }

    // Initial render + load recipes
    render();
    loadRecipes();
  </script>
</body>
</html>
